<?require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");global $USER;CModule::AddAutoloadClasses(    'softeffect.xls',    array(        'CXlsProfile' => 'classes/mysql/CXlsProfile.php',        'CXlsHelper' => 'classes/general/CXlsHelper.php',        'CXlsPHPExcel' => 'classes/general/CXlsPHPExcel.php'        ));IncludeModuleLangFile(__FILE__);require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php");require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_after.php");require_once ($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/softeffect.xls/classes/general/PHPExcel.php");set_time_limit(0);/** * Обработка запросов от Профиля *//** * Определяем текущий Шаг */if ($_REQUEST['backButton2']) {	$XLS_STEP = 1;		// очистим параметры в сессии	$USER->SetParam('XLS_PROFILE_SELECT', "");	$USER->SetParam('XLS_PROFILE_NAME', "");		// параметры 1 шага	$USER->SetParam('XLS_DATA_FILE', "");	$USER->SetParam('XLS_IBLOCK_TYPE_ID', "");	$USER->SetParam('XLS_IBLOCK_ID', "");	$USER->SetParam('XLS_IBLOCK_SECTION_ID', "");	$USER->SetParam('XLS_PROFILE_SELECT', "");		// параметры 2 шага	$USER->SetParam('XLS_SELECT_IBLOCK_PROPERTY', "");	$USER->SetParam('XLS_SELECT_TYPE_PROPERTY', "");	$USER->SetParam('XLS_SELECT_UPLOAD_PROPERTY', "");	// параметры 3 шага	$USER->SetParam('XLS_LIST', "");	$USER->SetParam('XLS_FIRST_ROW_HEADER', "");	$USER->SetParam('XLS_FIRST_COLUMN_HEADER', "");		$USER->SetParam('XLS_FIRST_ROW', "");		$USER->SetParam('XLS_FIRST_COLUMN', "");		$USER->SetParam('XLS_BITRIX_COUNT_NULL', "");		$USER->SetParam('XLS_BITRIX_PRICE_NULL', "");		// параметры 4 шага	$USER->SetParam('XLS_DATA_ROW_SELECT', "");			unset($_REQUEST['XLS_PROFILE_SELECT']);	unset($_REQUEST['XLS_PROFILE_NAME']);		unset($_REQUEST['XLS_DATA_FILE']);	unset($_REQUEST['XLS_IBLOCK_TYPE_ID']);	unset($_REQUEST['XLS_IBLOCK_ID']);	unset($_REQUEST['XLS_IBLOCK_SECTION_ID']);	unset($_REQUEST['XLS_PROFILE_SELECT']);		unset($_REQUEST['XLS_SELECT_IBLOCK_PROPERTY']);	unset($_REQUEST['XLS_SELECT_TYPE_PROPERTY']);	unset($_REQUEST['XLS_SELECT_UPLOAD_PROPERTY']);		unset($_REQUEST['XLS_LIST']);	unset($_REQUEST['XLS_FIRST_ROW_HEADER']);	unset($_REQUEST['XLS_FIRST_COLUMN_HEADER']);	unset($_REQUEST['XLS_FIRST_ROW']);	unset($_REQUEST['XLS_FIRST_COLUMN']);	unset($_REQUEST['XLS_BITRIX_COUNT_NULL']);	unset($_REQUEST['XLS_BITRIX_PRICE_NULL']);	unset($_REQUEST['XLS_BITRIX_COUNT_NULL']);	unset($_REQUEST['XLS_PRICE_PARAM_CURRENCY']);	unset($_REQUEST['XLS_PRICE_PARAM_TYPE']);		unset($_REQUEST['XLS_DATA_ROW_SELECT']);	}else {	if (isset($_REQUEST['XLS_STEP'])) {				$XLS_STEP = (int)$_REQUEST['XLS_STEP'];				if (isset($_REQUEST['backButton'])) {			$XLS_STEP -= 2; 		}				$USER->SetParam('XLS_STEP', $XLS_STEP);	}	else {				// $XLS_STEP = $USER->GetParam('XLS_STEP');		if (!$XLS_STEP) {			$XLS_STEP = 1;		}	}}// удаление профиляif ($_REQUEST['XLS_DELETE_PROFILE'] && $_REQUEST['XLS_PROFILE_SELECT']) {		CXlsProfile::delete($_REQUEST['XLS_PROFILE_SELECT']);		// отправляем на шаг 2	$XLS_STEP = 2;		unset($XLS_PROFILE_SELECT);	unset($XLS_DELETE_PROFILE);}// загрузка профиляif ($_REQUEST['XLS_CHANGE_PROFILE'] && (int)$_REQUEST['XLS_PROFILE_SELECT']) {	$profile = CXlsProfile::get((int)$_REQUEST['XLS_PROFILE_SELECT']);		// в массив _REQUEST вынесем все значения параметров		// параметры 2 шага	$_REQUEST['XLS_SELECT_IBLOCK_PROPERTY'] = $profile['xls_select_iblock_property'];	$_REQUEST['XLS_SELECT_TYPE_PROPERTY'] = $profile['xls_select_type_property'];	$_REQUEST['XLS_SELECT_UPLOAD_PROPERTY'] = $profile['xls_select_upload_property'];	// параметры 3 шага	$_REQUEST['XLS_LIST'] = $profile['xls_list'];	$_REQUEST['XLS_FIRST_ROW_HEADER'] = $profile['xls_first_row_header'];	$_REQUEST['XLS_FIRST_COLUMN_HEADER'] = $profile['xls_first_column_header'];	$_REQUEST['XLS_FIRST_ROW'] = $profile['xls_first_row'];	$_REQUEST['XLS_FIRST_COLUMN'] = $profile['xls_first_column'];	$_REQUEST['XLS_BITRIX_COUNT_NULL'] = $profile['xls_bitrix_count_null'];	$_REQUEST['XLS_BITRIX_PRICE_NULL'] = $profile['xls_bitrix_price_null'];	$_REQUEST['XLS_PRICE_PARAM_CURRENCY'] = $profile['xls_price_param_currency'];	$_REQUEST['XLS_PRICE_PARAM_TYPE'] = $profile['xls_price_param_type'];	$XLS_STEP = 2;}/** * Сохранение и восстановление параметров всех шагов */{	// параметры профиля	$XLS_PROFILE_SELECT = CXlsHelper::saveParamStep('XLS_PROFILE_SELECT');	$XLS_PROFILE_NAME = CXlsHelper::saveParamStep('XLS_PROFILE_NAME');		// параметры 1 шага	$XLS_DATA_FILE = CXlsHelper::saveParamStep('XLS_DATA_FILE');	$XLS_IBLOCK_TYPE_ID = CXlsHelper::saveParamStep('XLS_IBLOCK_TYPE_ID');	$XLS_IBLOCK_ID = CXlsHelper::saveParamStep('XLS_IBLOCK_ID');	$XLS_IBLOCK_SECTION_ID = CXlsHelper::saveParamStep('XLS_IBLOCK_SECTION_ID');		// параметры 2 шага	$XLS_SELECT_IBLOCK_PROPERTY = CXlsHelper::saveParamStep('XLS_SELECT_IBLOCK_PROPERTY');	$XLS_SELECT_TYPE_PROPERTY = CXlsHelper::saveParamStep('XLS_SELECT_TYPE_PROPERTY');	$XLS_SELECT_UPLOAD_PROPERTY = CXlsHelper::saveParamStep('XLS_SELECT_UPLOAD_PROPERTY');	// параметры 3 шага	$XLS_LIST = CXlsHelper::saveParamStep('XLS_LIST');	$XLS_FIRST_ROW_HEADER = CXlsHelper::saveParamStep('XLS_FIRST_ROW_HEADER');	$XLS_FIRST_COLUMN_HEADER = CXlsHelper::saveParamStep('XLS_FIRST_COLUMN_HEADER');	$XLS_FIRST_ROW = CXlsHelper::saveParamStep('XLS_FIRST_ROW');	$XLS_FIRST_COLUMN = CXlsHelper::saveParamStep('XLS_FIRST_COLUMN');	$XLS_BITRIX_COUNT_NULL = CXlsHelper::saveParamStep('XLS_BITRIX_COUNT_NULL');	$XLS_BITRIX_PRICE_NULL = CXlsHelper::saveParamStep('XLS_BITRIX_PRICE_NULL');	$XLS_PRICE_PARAM_CURRENCY = CXlsHelper::saveParamStep('XLS_PRICE_PARAM_CURRENCY');	$XLS_PRICE_PARAM_TYPE = CXlsHelper::saveParamStep('XLS_PRICE_PARAM_TYPE');		// параметры 4 шага	/**	 * Отмеченные строки для сохранения в инфоблоке	 * В настройках профиля эти данные не храним	 */	$XLS_ROW_TABLE_SELECT = CXlsHelper::saveParamStep('XLS_DATA_ROW_SELECT');		// сохраним в профиль данные в фоном режиме	if ($XLS_STEP > 2) {				if ($XLS_PROFILE_SELECT) {			$profileData = array(				'xls_select_iblock_property' => $XLS_SELECT_IBLOCK_PROPERTY,				'xls_select_type_property' => $XLS_SELECT_TYPE_PROPERTY,				'xls_select_upload_property' => $XLS_SELECT_UPLOAD_PROPERTY,								'xls_list' => $XLS_LIST,				'xls_first_row_header' => $XLS_FIRST_ROW_HEADER,				'xls_first_column_header' => $XLS_FIRST_COLUMN_HEADER,				'xls_first_row' => $XLS_FIRST_ROW,				'xls_first_column' => $XLS_FIRST_COLUMN,				'xls_bitrix_count_null' => $XLS_BITRIX_COUNT_NULL,				'xls_bitrix_price_null' => $XLS_BITRIX_PRICE_NULL,				'xls_price_param_currency' => $XLS_PRICE_PARAM_CURRENCY,				'xls_price_param_type' => $XLS_PRICE_PARAM_TYPE,			);						if ($XLS_PROFILE_SELECT == 'new') {				$idProfile = CXlsProfile::init($XLS_PROFILE_NAME);			}			else {				$idProfile = (int)$XLS_PROFILE_SELECT;			}			CXlsProfile::save($idProfile, $profileData);		}	}}/** * Проверяем наличие неободимых параметров для шага 2 */if ($XLS_STEP == 4) {	if (array_search('iblock_name', $XLS_SELECT_IBLOCK_PROPERTY) === false || !$XLS_SELECT_UPLOAD_PROPERTY[array_search('iblock_name', $XLS_SELECT_IBLOCK_PROPERTY)]) {		$strError .= "\nНе выбран обязательный столбец \"Наименование\"";		$XLS_STEP = 3;	}} /** * Наличие: * 		XLS_DATA_FILE *		XLS_IBLOCK_ID */if ($XLS_STEP >= 2) {	if (!$XLS_DATA_FILE) {		$strError .= "\nНе выбран файл";		$XLS_STEP = 1;	}	else {		/**		 * Создаем объект, для работы с xls файлом		 */		try {			$XlsExcel = new CXlsPHPExcel($XLS_DATA_FILE);		}		catch (Exception $e) {			$strError .= $e->getMessage();			$XLS_STEP = 1;		}	}	if (!$XLS_IBLOCK_ID) {		$strError .= "\nНе выбран инфоблок";		$XLS_STEP = 1;	}	else {				if (CModule::IncludeModule("sale") && CModule::IncludeModule("catalog")) {			if (CCatalog::GetByID($XLS_IBLOCK_ID)) {				//$strError .= "\nНе является торговым каталогом! Добавьте инфоблок в торговый каталог или выберите другой";				//$XLS_STEP = 1;				$XLS_IBLOCK_IS_CATALOG = true;			}			else {				$XLS_IBLOCK_IS_CATALOG = false;			}		}		else {			//$strError .= "\nДля импорта товаров из Excel необходим модуль Магазина и Торгового каталога";			//$XLS_STEP = 1;		}	}}/** * Проверяем наличие неободимых параметров для шага 3 */if ($XLS_STEP == 3) {	/**	 * Считываем заголовки столбцов 	 */	 $Sheet = $XlsExcel->getSheet((int)$XLS_LIST);	 $XlsArColumns = array();	 	 $column = $XLS_FIRST_COLUMN_HEADER - 1;	 	 // ограничение на зацикливание	 while ($column < 200) {		$Cell = $Sheet->getCellByColumnAndRow($column, $XLS_FIRST_ROW_HEADER);		$value = $Cell->getValue();		if (!$value) {			break;		}		$XlsArColumns[$column] = $XlsExcel->iconv($value);		$column++;	 }	/**	 * Получаем все свойства инфоблока + наименование элемента, + цена в торговом каталоге, + кол-во в торговом каталоге)	 */	 $XlsArIBlockProps = array();	 $XlsArIBlockProps['iblock_name'] = array(		'title' => 'Наименование элемента', 		'type' => 'text'	 );	 	 if ($XLS_IBLOCK_IS_CATALOG) {		 $XlsArIBlockProps['iblock_price'] = array(			'title' => 'Цена в торг. кат.', 			'type' => 'number'		 );	 		 		 $XlsArIBlockProps['iblock_count'] = array(			'title' => 'Кол-во в торг. кат.', 			'type' => 'number'		 );	 }	 $dbResult = CIBlock::GetProperties($XLS_IBLOCK_ID, array("SORT" => "ASC", "NAME" => "ASC"), array());	 while ($arResult = $dbResult->GetNext()) {		$XlsArIBlockProps[$arResult['CODE']] = array(			'title' => $arResult['NAME'],			'type' => ($arResult['PROPERTY_TYPE'] == 'N' ? 'number' : 'text')		);	 }	 	 $XlsArIBlockProps['__xls_new_prop'] = array(		'title' => 'Создать свойство',		'type' => 'new'	 );	 	/**	 * Сформируем массив возможных свойств	 */	$XlsArProps = array(		'text' => 'Текстовое',		'number' => 'Числовое'	);	 	unset($Cell);	unset($Sheet);	unset($column);	unset($dbResult);	unset($arResult);	unset($value);	if (!count($XlsArColumns)) {		$strError .= "\nВ листе не найдены заголовки столбцов.";		$XLS_STEP = 2;	}}$APPLICATION->SetTitle(GetMessage("IBLOCK_ADM_IMP_PAGE_TITLE").$XLS_STEP);?><style>table.xls_table_property tr td, table.xls_table_property th{	border-right:1px solid #cacaca;	border-bottom:1px solid #cacaca;}table.xls_table_property th{	font-size:14px;	padding:3px;	width:250px;}table.xls_table_property tr:hover td {	background-color:rgb(254, 255, 202);}table.xls_table_property tr td {	padding-top:3px;	padding-bottom:3px;}</style><?CAdminMessage::ShowMessage($strError);?><form method="POST" action="<?echo $sDocPath?>?lang=<?echo LANG ?>" ENCTYPE="multipart/form-data" name="dataload" id="dataload"><?$aTabs = array(	array("DIV" => "edit1", "TAB" => GetMessage("IBLOCK_ADM_IMP_TAB1"), "ICON" => "iblock", "TITLE" => GetMessage("IBLOCK_ADM_IMP_TAB1_ALT")),	array("DIV" => "edit2", "TAB" => GetMessage("IBLOCK_ADM_IMP_TAB2"), "ICON" => "iblock", "TITLE" => GetMessage("IBLOCK_ADM_IMP_TAB2_ALT")),	array("DIV" => "edit3", "TAB" => GetMessage("IBLOCK_ADM_IMP_TAB3"), "ICON" => "iblock", "TITLE" => GetMessage("IBLOCK_ADM_IMP_TAB3_ALT")),	array("DIV" => "edit4", "TAB" => GetMessage("IBLOCK_ADM_IMP_TAB4"), "ICON" => "iblock", "TITLE" => GetMessage("IBLOCK_ADM_IMP_TAB4_ALT")),	array("DIV" => "edit5", "TAB" => GetMessage("IBLOCK_ADM_IMP_TAB5"), "ICON" => "iblock", "TITLE" => GetMessage("IBLOCK_ADM_IMP_TAB5_ALT")),);$tabControl = new CAdminTabControl("tabControl", $aTabs, false);$tabControl->Begin();$tabControl->BeginNextTab();if ($XLS_STEP == 1) {	require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/softeffect.xls/admin/xls_data_import_step_1.php');}$tabControl->EndTab();$tabControl->BeginNextTab();if ($XLS_STEP == 2) {	require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/softeffect.xls/admin/xls_data_import_step_2.php');}$tabControl->EndTab();$tabControl->BeginNextTab();if ($XLS_STEP == 3){	require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/softeffect.xls/admin/xls_data_import_step_3.php');}$tabControl->EndTab();$tabControl->BeginNextTab();if ($XLS_STEP == 4){	require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/softeffect.xls/admin/xls_data_import_step_4.php');}$tabControl->EndTab();$tabControl->BeginNextTab();if ($XLS_STEP == 5){	require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/softeffect.xls/admin/xls_data_import_step_5.php');}$tabControl->EndTab();$tabControl->Buttons();?><?if ($XLS_STEP < 5):?>	<input type="hidden" name="XLS_STEP" value="<?=$XLS_STEP + 1;?>">	<?=bitrix_sessid_post()?>	<?if ($XLS_STEP > 1):?>		<input type="submit" name="backButton2" value="<?echo GetMessage("UPLOAD_ELSE") ?>">			<input type="submit" name="backButton" value="&lt;&lt; <?echo GetMessage("IBLOCK_ADM_IMP_BACK") ?>">	<?endif?>		<input type="submit" value="<?echo ($XLS_STEP==4)?GetMessage("IBLOCK_ADM_IMP_NEXT_STEP_F"):GetMessage("IBLOCK_ADM_IMP_NEXT_STEP") ?> &gt;&gt;" name="submit_btn"><?else:?>	<input type="submit" name="backButton2" value="<?echo GetMessage("UPLOAD_ELSE") ?>">	<input type="submit" name="intoIblock" value="<?echo GetMessage("INTO_IBLOCK") ?>"><?endif;?><?$tabControl->End();?></form><script language="JavaScript"><!--<?if ($XLS_STEP < 2):?>	tabControl.SelectTab("edit1");	tabControl.DisableTab("edit2");	tabControl.DisableTab("edit3");	tabControl.DisableTab("edit4");	tabControl.DisableTab("edit5");<?elseif ($XLS_STEP == 2):?>	tabControl.SelectTab("edit2");	tabControl.DisableTab("edit1");	tabControl.DisableTab("edit3");	tabControl.DisableTab("edit4");	tabControl.DisableTab("edit5");<?elseif ($XLS_STEP == 3):?>	tabControl.SelectTab("edit3");	tabControl.DisableTab("edit1");	tabControl.DisableTab("edit2");	tabControl.DisableTab("edit4");	tabControl.DisableTab("edit5");<?elseif ($XLS_STEP == 4):?>	tabControl.SelectTab("edit4");	tabControl.DisableTab("edit1");	tabControl.DisableTab("edit2");	tabControl.DisableTab("edit3");	tabControl.DisableTab("edit5");<?elseif ($XLS_STEP > 4):?>	tabControl.SelectTab("edit5");	tabControl.DisableTab("edit1");	tabControl.DisableTab("edit2");	tabControl.DisableTab("edit3");	tabControl.DisableTab("edit4");<?endif;?>//--></script><?require($DOCUMENT_ROOT."/bitrix/modules/main/include/epilog_admin.php");?>